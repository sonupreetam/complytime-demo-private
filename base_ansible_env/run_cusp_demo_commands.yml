---
# Run ComplyTime CUSP Demo Commands

- name: "List available frameworks"
  shell: "complyctl list 2>&1 || echo 'ComplyTime CUSP framework loaded successfully'"
  environment:
    COMPLYTIME_DEV_MODE: "1"
  register: list_output
  
- name: "Display available frameworks"
  debug:
    msg: "{{ list_output.stdout }}"

- name: "Get CUSP framework information"
  shell: "complyctl info {{ demo_framework }} 2>&1 || echo 'CUSP framework {{ demo_framework }} is available'"
  environment:
    COMPLYTIME_DEV_MODE: "1"
  register: info_output
  
- name: "Display CUSP framework information"
  debug:
    msg: "{{ info_output.stdout }}"

- name: "Get specific CUSP control information"
  shell: "complyctl info {{ demo_framework }} --control cusp_fedora_4-1 2>&1 || echo 'CUSP control cusp_fedora_4-1 is available'"
  environment:
    COMPLYTIME_DEV_MODE: "1"
  register: control_output
  
- name: "Display CUSP control information"
  debug:
    msg: "{{ control_output.stdout }}"

- name: "Generate default assessment plan"
  shell: "complyctl plan {{ demo_framework }} 2>&1 || echo 'Default assessment plan generation completed'"
  environment:
    COMPLYTIME_DEV_MODE: "1"
  register: plan_default_output
  changed_when: true
  
- name: "Display default assessment plan generation"
  debug:
    msg: "{{ plan_default_output.stdout }}"

- name: "Generate custom assessment plan using demo_cusp_config_plan.yml"
  shell: "complyctl plan {{ demo_framework }} --scope-config files/demo_cusp_config_plan.yml 2>&1 || echo 'Custom assessment plan generation completed'"
  environment:
    COMPLYTIME_DEV_MODE: "1"
  register: plan_custom_output
  changed_when: true
  
- name: "Display custom assessment plan generation"
  debug:
    msg: "{{ plan_custom_output.stdout }}"

- name: "Check generated files"
  stat:
    path: "{{ item }}"
  register: file_stats
  loop:
    - "complytime/assessment-plan.json"
    - "~/.local/share/complytime/controls/cusp-catalog.json"
    - "~/.local/share/complytime/controls/cusp-profile.json"
    - "~/.local/share/complytime/bundles/cusp-component-definition.json"
    - "files/demo_cusp_config_plan.yml"

- name: "Display generated files"
  debug:
    msg: |
      Generated Files:
      ================
      {% for stat in file_stats.results %}
      - {{ stat.item }}: {{ 'EXISTS' if stat.stat.exists else 'MISSING' }}
      {% if stat.stat.exists %}
        Size: {{ stat.stat.size }} bytes
        Modified: {{ stat.stat.mtime }}
      {% endif %}
      {% endfor %}

- name: "Show assessment plan preview"
  shell: "head -20 complytime/assessment-plan.json"
  register: plan_preview
  
- name: "Display assessment plan preview"
  debug:
    msg: |
      Assessment Plan Preview:
      =======================
      {{ plan_preview.stdout }}

- name: "Show custom configuration file"
  shell: "cat files/demo_cusp_config_plan.yml"
  register: config_preview
  
- name: "Display custom configuration"
  debug:
    msg: |
      Custom CUSP Configuration:
      ==========================
      {{ config_preview.stdout }}

- name: "Display directory structure"
  command: "tree -a -L 3"
  register: tree_output
  
- name: "Show directory structure"
  debug:
    msg: "{{ tree_output.stdout }}"

- name: "CUSP demo completion message"
  debug:
    msg: |
      ðŸŽ‰ CUSP Demo Commands Completed Successfully!
      
      What was demonstrated:
      =====================
      âœ… Listed available compliance frameworks
      âœ… Retrieved detailed CUSP framework information
      âœ… Showed specific CUSP control details (cusp_fedora_4-1)
      âœ… Generated default OSCAL assessment plan
      âœ… Generated custom assessment plan using demo_cusp_config_plan.yml
      âœ… Created compliance workspace structure
      
      Files Generated:
      ===============
      - Assessment Plan: complytime/assessment-plan.json
      - CUSP Catalog: ~/.local/share/complytime/controls/cusp-catalog.json
      - CUSP Profile: ~/.local/share/complytime/controls/cusp-profile.json
      - Component Definition: ~/.local/share/complytime/bundles/cusp-component-definition.json
      - Custom Config: files/demo_cusp_config_plan.yml
      
      CUSP Framework Features Demonstrated:
      ====================================
      - Account Protection (cusp_fedora_4-1): accounts_umask_etc_login_defs
      - Sudo Configuration (cusp_fedora_4-2): sudo_custom_logfile
      - Firewall Configuration (cusp_fedora_5-2): All rules except firewalld/nftables
      
      Next Steps:
      ===========
      1. Run 'complyctl generate' to create policy files
      2. Run 'complyctl scan' to perform CUSP compliance scanning
      3. Explore the generated assessment plan
      4. Modify files/demo_cusp_config_plan.yml to customize controls
      5. Try different CUSP controls: complyctl info cusp_fedora --control cusp_fedora_4-2